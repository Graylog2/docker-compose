version: "3.8"

services:
  m01:
    image: "mongo:4.2"
    ports:
      - "27017:27017"
    volumes:
      - "m01configdb:/data/configdb"
      - "m01db:/data/db"
    networks:
      - graylog
  e01:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    environment:
      - node.name=e01
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=e02,e03
      - cluster.initial_master_nodes=e01,e02,e03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - esdata01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    networks:
      - graylog
  e02:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    environment:
      - node.name=e02
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=e01,e03
      - cluster.initial_master_nodes=e01,e02,e03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - esdata02:/usr/share/elasticsearch/data
    ports:
      - 9201:9200
    networks:
      - graylog
  e03:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    environment:
      - node.name=e03
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=e01,e02
      - cluster.initial_master_nodes=e01,e02,e03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - esdata03:/usr/share/elasticsearch/data
    ports:
      - 9202:9200
    networks:
      - graylog
  g01:
    image: graylog/graylog:4.1.0-1.beta.1
    environment:
      # CHANGE ME (must be at least 16 characters)!
      - GRAYLOG_PASSWORD_SECRET=somepasswordpepper
      # Password: admin
      - GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
      - GRAYLOG_HTTP_EXTERNAL_URI=http://127.0.0.1:9000/
      - GRAYLOG_ELASTICSEARCH_HOSTS=http://e01:9200,http://e02:9201,http://e03:9202
      - GRAYLOG_MONGODB_URI=mongodb://m01:27017/graylog
    entrypoint: /docker-entrypoint.sh
    networks:
      - graylog
    restart: always
    depends_on:
      - m01
      - e01
      - e02
      - e03
    ports:
      # Graylog web interface and REST API
      - 9000:9000
      # Syslog TCP
      - 1514:1514
      # Syslog UDP
      - 1514:1514/udp
      # GELF TCP
      - 12201:12201
      # GELF UDP
      - 12201:12201/udp
  g02:
    image: graylog/graylog:4.1.0-1.beta.1
    environment:
      - GRAYLOG_IS_MASTER=false
      # CHANGE ME (must be at least 16 characters)!
      - GRAYLOG_PASSWORD_SECRET=somepasswordpepper
      # Password: admin
      - GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
      - GRAYLOG_HTTP_EXTERNAL_URI=http://127.0.0.1:9000/
      - GRAYLOG_HTTP_BIND_ADDRESS=0.0.0.0:9001
      - GRAYLOG_ELASTICSEARCH_HOSTS=http://e01:9200,http://e02:9201,http://e03:9202
      - GRAYLOG_MONGODB_URI=mongodb://m01:27017/graylog
    entrypoint: /docker-entrypoint.sh
    networks:
      - graylog
    restart: always
    depends_on:
      - m01
      - e01
      - e02
      - e03
    ports:
      # Graylog web interface and REST API
      - 9001:9001
      # Syslog TCP
      - 1515:1514
      # Syslog UDP
      - 1515:1514/udp
      # GELF TCP
      - 12202:12201
      # GELF UDP
      - 12202:12201/udp
  g03:
    image: graylog/graylog:4.1.0-1.beta.1
    environment:
      - GRAYLOG_IS_MASTER=false
      # CHANGE ME (must be at least 16 characters)!
      - GRAYLOG_PASSWORD_SECRET=somepasswordpepper
      # Password: admin
      - GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
      - GRAYLOG_HTTP_EXTERNAL_URI=http://127.0.0.1:9000/
      - GRAYLOG_HTTP_BIND_ADDRESS=0.0.0.0:9002
      - GRAYLOG_ELASTICSEARCH_HOSTS=http://e01:9200,http://e02:9201,http://e03:9202
      - GRAYLOG_MONGODB_URI=mongodb://m01:27017/graylog
    entrypoint: /docker-entrypoint.sh
    networks:
      - graylog
    restart: always
    depends_on:
      - m01
      - e01
      - e02
      - e03
    ports:
      # Graylog web interface and REST API
      - 9002:9002
      # Syslog TCP
      - 1516:1514
      # Syslog UDP
      - 1516:1514/udp
      # GELF TCP
      - 12203:12201
      # GELF UDP
      - 12203:12201/udp

volumes:
  m01configdb:
  m01db:
  esdata01:
  esdata02:
  esdata03:

networks:
  graylog:
    driver: bridge
